jQuery(function(a){configureWidgets();applyFormStyling();enableRowSelection();enableColumnSorting();enableShortcuts();enableCheckboxSubmission()});function configureWidgets(){$.datepicker.setDefaults({dateFormat:"dd/mm/yy",showOn:"button",buttonImage:rootContext+"public/images/date.png",buttonText:"",buttonImageOnly:true,constrainInput:false});jsPlumb.importDefaults({Anchors:["RightMiddle","LeftMiddle"],Connector:["Straight"],Endpoint:["Dot",{radius:5}],EndpointStyle:{fillStyle:"#ccc"},PaintStyle:{lineWidth:5,strokeStyle:"#ccc"},ConnectionsDetachable:false});$("div.tabs").tabs({cookie:{expires:1},select:function(a,b){jsPlumb.reset()},load:function(a,b){applyFormStyling($(a.target));enableRowSelection($(a.target));renderSchematic();renderGraphs()}});setTimeout(function(){if(location.hash){window.scrollTo(0,0)}},1);$(window).resize(function(){$.doTimeout("resize",250,function(){jsPlumb.repaintEverything()})});if($("#site-search").length){$("#site-search").each(enableLocationAutocomplete).autocomplete("option","position",{my:"right top",at:"right bottom"}).autocomplete("option","select",function(a,b){location=rootContext+b.item.url;return false})}}function applyFormStyling(a){if(a===undefined){a=$("body")}a.find("div.options a, div.search a, div.links a, td.actions a, input:submit, a.cancel").button();a.find("div.links a.disabled").button("disable");a.find("input.date").datepicker({beforeShow:function(b,c){return !b.disabled}});a.find("a.inplace").click(function(){var b=$(this);showInplacePartial(b.data("url"),b.data("content"));return false});a.find("a.dialog").click(function(){var b=$(this);showRemoteDialog(b.data("url"),b.data("title"))});a.find("a.filter").click(showFilterDialog);a.find("a.export").click(configureExport);a.find("input.quicksearch").keyup(function(){$.doTimeout("quicksearch",250,applyQuickSearch)});a.find("#location").each(enableLocationAutocomplete);a.find(".autocomplete").each(enableGenericAutocomplete);a.find("#hazard").each(enableHazardSelection);a.find("#process").each(enableProcessSelection);a.find("input.autofocus:first").focus();a.find("form.validate").submit(function(){$(this).find(".error").hide()}).bind("formIsValid",function(){$(".flash").remove()}).bind("formIsInvalid",function(){if(!$(".flash").length){$("<div/>",{text:"Validation failed, please check errors below","class":"flash error"}).appendTo(".flash-placeholder")}}).ketchup({validateEvents:"blur click change",createErrorContainer:function(e,d){var b=d.parent(),c=b.find(".error");return c.length?c:$("<span/>",{"class":"error"}).appendTo(b)},showErrorContainer:function(d,c,b){b.show()},hideErrorContainer:function(d,c,b){b.hide()},addErrorMessages:function(e,c,b,d){b.text(d[0])}})}function applyDialogStyling(a){var b;a.find(".dialogDate").addClass("date");a.find(".add-filter").click(addMultiFilter);a.find(".remove-filter").click(removeMultiFilter);a.find(".dialogMulti").addClass("multi");b=a.find("form");b.submit(function(){$(this).parents(".ui-dialog").first().find(".ui-button").first().click();return false});applyFormStyling(a);return b}function enableRowSelection(a){if(a===undefined){a=$("table")}a.find("tr.rowselect").click(function(){$("a:first",this).each(function(){var b=$(this);$.cookie("source",b.data("source"),{raw:true});location=b.attr("href")});return false})}function enableColumnSorting(){$("a.sort, .pagination a").live("click",function(){var b=$(this),a=b.closest("table.list");if(b.parent().hasClass("off")){return false}$.ajax({url:b.attr("href"),cache:false,success:function(d){var e=$(d),c=e.find("table");a.replaceWith(c.length?c:e);enableRowSelection()}});return false})}function showRemoteDialog(a,b){$.ajax({url:a,cache:false,success:function(c){var d=$("<div/>").addClass("dialog");d.html(c);$("body").append(d);d.dialog({title:b,width:710,modal:true,buttons:{Okay:function(){var e=$(this),f=e.find("form");$.post(f.attr("action"),f.serialize(),function(h,g,i){if(h.indexOf("authenticityToken")<0){window.location=h}else{f.parent().replaceWith(h)}})},Cancel:function(){$(this).dialog("close")}},create:function(){applyDialogStyling($(this))},beforeClose:function(){d.remove()}})}})}function showFilterDialog(){var d=$(this),c=$(".searchForm"),b=c.find("form"),a;var e=c.clone().dialog({title:d.text(),width:710,modal:true,buttons:{Filter:function(){a.find("input,select").each(function(g,f){b.find("input,select").eq(g).val($(f).val())});fetchSearchResults();$(this).dialog("close")},Clear:function(){a.find("input,select").val("")},Cancel:function(){$(this).dialog("close")}},create:function(){applyDialogStyling($(this));a=$(this).find("form")},beforeClose:function(){e.remove()}});return false}function addMultiFilter(){var d=$(".searchForm form"),b=$(this).parent(),a=b.clone(),c=a.find("a"),e;c.find("span").text("-");c.removeClass("add-filter").addClass("remove-filter");c.click(removeMultiFilter);a.insertAfter(b);e=d.find("li").eq(b.index());a.clone().insertAfter(e);return false}function removeMultiFilter(){var d=$(".searchForm form"),c=$(this),b=c.parent(),a=b.index();b.remove();d.find("li").eq(a).remove();return false}function configureExport(){var e=$(this),f=$(".export-parameters"),d=$(".export-count").val(),c=$(".searchForm form"),b=e.data("url"),a=e.data("limit");if(a&&d&&d>a){alert("Export limit of "+a+" rows exceeded. Please apply a filter to reduce the number of rows and try again.");return false}if(f.length){b=b+"?"+f.val();if(c.length){b=b+"&"+c.serialize()}}e.prop("href",b)}function applyQuickSearch(){var b=$("input.quicksearch").val(),a=$(".searchForm form");a.find("input.searchtext").val(b);fetchSearchResults();return false}function fetchSearchResults(){var a=$(".searchForm form").first();$.ajax({url:a.attr("action"),data:a.serialize(),cache:false,success:function(b){var c=$(b),d=$(".results");d.replaceWith(c);enableRowSelection()}})}function enableLocationAutocomplete(){var a=$(this),b=a.autocomplete({minLength:2,source:$(this).data("url"),focus:function(c,d){a.val(d.item.name);return false},select:function(c,d){$("#locationId").val(d.item.id);a.val(d.item.name);return false}}).data("autocomplete");b._renderItem=function(c,d){var e="<strong>"+d.name+"</strong> ("+d.locationType+")";return $("<li></li>").data("item.autocomplete",d).append("<a>"+e+"</a>").appendTo(c)};b._renderMenu=function(f,e){var d=this,c="";$.each(e,function(g,h){if(h.supplySystemStage!=c){c=h.supplySystemStage;f.append("<li class='ui-autocomplete-category'>"+c+"</li>")}d._renderItem(f,h)})}}function enableGenericAutocomplete(){$(this).autocomplete({minLength:2,source:$(this).data("url")})}function enableHazardSelection(){var a=$(this);a.change(function(){$.ajax({url:a.data("url"),data:{id:a.val()},cache:false,success:function(b){a.closest("form").find("#determinand").empty().append(b)}})})}function enableProcessSelection(){var a=$(this);a.change(function(){$.ajax({url:a.data("url"),data:{processId:a.val()},cache:false,success:function(b){var c=$(b),d=a.closest("form");d.find("#attribs").html(c.find("#attribs").html());d.find("#hazards").html(c.find("#hazards").html());d.find("#failures").html(c.find("#failures").html());d.find("#monitoring").html(c.find("#monitoring").html());d.find("#verification").html(c.find("#verification").html())}})})}function renderSchematic(){var a=$("#here"),b=$("#schematic");if(a.length){jsPlumb.setSuspendDrawing(true);$("[id^=upstream_]").each(function(){var c=$(this);jsPlumb.connect({source:c.prop("id"),target:a.prop("id")})});$("[id^=downstream_]").each(function(){var c=$(this);jsPlumb.connect({source:a.prop("id"),target:c.prop("id")})});jsPlumb.setSuspendDrawing(false,true)}}function renderGraphs(){var e=$("#sample-graph");if(e.length){var b=e.data("samples"),f=e.data("al"),c=e.data("pcv"),a={xaxis:{mode:"time",timeformat:"%d %b %y",minTickSize:[1,"day"],zoomRange:[1,100]},yaxis:{zoomRange:[1,100]},series:{color:"#f00",threshold:[{below:f,color:"#009a3d"},{below:c,color:"#bb0"}]},grid:{backgroundColor:{colors:["#a1c6cf","#fff"]}},zoom:{interactive:true},pan:{interactive:true}},d=[];$.each(b,function(g,h){d.push([h.sampleDate,h.measurementNumericResult])});$.plot(e,[d],a)}}function enableShortcuts(){$(document).bind("keyup","left",function(){$("table.list li.previous a").click()});$(document).bind("keyup","right",function(){$("table.list li.next a").click()})}function enableCheckboxSubmission(){$("input[type=checkbox].option").click(function(){var a=this.checked;$(this).siblings("input[type=hidden]").val(a?"true":"false")})}function showInplacePartial(a,b){if(b=="edit"){$("div.inplace_content").hide();$("div.inplace_content_edit").show()}else{if(b=="save"){$("div.inplace_content").show();$("div.inplace_content_edit").hide()}else{$("div.inplace_content").show();$("div.inplace_content_edit").hide()}}}function confirmDlg(c){var b=$(this),a=$("#confirm-dialog");var d=a.clone().dialog({title:"Remove item",width:480,modal:true,buttons:{Yes:function(){c();$(this).dialog("close")},No:function(){$(this).dialog("close")}},create:function(){form=applyDialogStyling($(this))},beforeClose:function(){d.remove()}});return false};